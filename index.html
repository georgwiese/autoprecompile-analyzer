<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APC Effectiveness Analyzer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        .drop-zone {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }

        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .stats-table {
            max-height: 400px;
            overflow-y: auto;
        }

        .table-row-highlight {
            background-color: #ffc10755 !important;
        }
        
        .table-row-selected {
            background-color: #ffc107 !important;
        }

        .bar-highlight {
            stroke: #ffc10755 !important;
            stroke-width: 2 !important;
        }
        
        .bar-selected {
            stroke: #ffc107 !important;
            stroke-width: 4 !important;
        }

        .code-panel {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-line {
            margin: 2px 0;
            padding: 2px 5px;
        }

        .code-line:hover {
            background-color: #e9ecef;
        }

        .tooltip {
            position: absolute;
            text-align: left;
            padding: 10px;
            font: 12px sans-serif;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            z-index: 1000;
        }

        .bar {
            stroke: black;
            stroke-width: 0.5;
            opacity: 0.8;
            cursor: pointer;
        }

        .bar:hover {
            opacity: 1;
        }

        .mean-line {
            stroke: red;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            opacity: 0.7;
        }

        .grid line {
            stroke: #e0e0e0;
            stroke-opacity: 0.7;
        }

        .grid path {
            stroke-width: 0;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1" id="pageTitle" style="cursor: pointer;">APC Effectiveness Analyzer</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- File Upload Section -->
        <div id="uploadSection" class="row mb-4">
            <div class="col-12">
                <div class="drop-zone" id="dropZone">
                    <h4>Drop JSON file here or click to upload</h4>
                    <p class="text-muted">Upload APC candidates JSON file</p>
                    <input type="file" id="fileInput" accept=".json" style="display: none;">
                </div>
                <div class="mt-3">
                    <div class="input-group">
                        <span class="input-group-text">Or paste URL:</span>
                        <input type="text" id="urlInput" class="form-control" placeholder="https://example.com/data.json or GitHub link">
                        <button class="btn btn-primary" id="loadUrlBtn">Load from URL</button>
                    </div>
                    <small class="text-muted">Supports direct JSON URLs and GitHub file links</small>
                </div>
            </div>
        </div>

        <!-- Controls Section (hidden initially) -->
        <div id="controlsSection" class="row mb-4" style="display: none;">
            <div class="col-12">
                <label for="effectivenessType" class="form-label">Effectiveness Metric:</label>
                <select id="effectivenessType" class="form-select">
                    <option value="cost" selected>Cost</option>
                    <option value="main_columns">Main Columns</option>
                    <option value="constraints">Constraints</option>
                    <option value="bus_interactions">Bus Interactions</option>
                </select>
            </div>
        </div>

        <!-- Visualization Section (hidden initially) -->
        <div id="vizSection" style="display: none;">
            <div class="row">
                <div class="col-lg-8">
                    <div class="chart-container">
                        <div id="chart"></div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-container">
                        <h5>Top 10 Basic Blocks by Trace Cells</h5>
                        <div class="stats-table">
                            <table class="table table-sm table-hover" id="statsTable">
                                <thead>
                                    <tr>
                                        <th>Start PC</th>
                                        <th>Trace Cells</th>
                                        <th>Effectiveness</th>
                                        <th>Instructions</th>
                                    </tr>
                                </thead>
                                <tbody id="statsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Panel Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h5>Basic Block Code</h5>
                        <div class="mb-2">
                            <span id="codeBlockInfo" class="text-muted">Click on a bar or table row to see the code</span>
                        </div>
                        <div id="codePanel" class="code-panel">
                            <span class="text-muted">No block selected</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let chart = null;
        let selectedBlock = null;

        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const controlsSection = document.getElementById('controlsSection');
        const vizSection = document.getElementById('vizSection');
        const effectivenessType = document.getElementById('effectivenessType');
        const pageTitle = document.getElementById('pageTitle');

        // Drop zone events
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // URL loading functionality
        const urlInput = document.getElementById('urlInput');
        const loadUrlBtn = document.getElementById('loadUrlBtn');

        loadUrlBtn.addEventListener('click', loadFromUrl);
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadFromUrl();
            }
        });

        async function loadFromUrl() {
            const url = urlInput.value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            // Convert GitHub URLs to raw URLs
            let fetchUrl = url;
            if (url.includes('github.com') && !url.includes('raw.githubusercontent.com')) {
                // Convert github.com/user/repo/blob/branch/file to raw.githubusercontent.com/user/repo/branch/file
                fetchUrl = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            }

            try {
                loadUrlBtn.disabled = true;
                loadUrlBtn.textContent = 'Loading...';
                
                const response = await fetch(fetchUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                try {
                    currentData = JSON.parse(text);
                    uploadSection.style.display = 'none';
                    controlsSection.style.display = 'block';
                    vizSection.style.display = 'block';
                    updateVisualization();
                } catch (parseError) {
                    alert('Error parsing JSON from URL: ' + parseError.message);
                }
            } catch (error) {
                alert('Error loading URL: ' + error.message);
            } finally {
                loadUrlBtn.disabled = false;
                loadUrlBtn.textContent = 'Load from URL';
            }
        }

        effectivenessType.addEventListener('change', () => {
            if (currentData) {
                selectedBlock = null;  // Clear selection when changing metric
                updateVisualization();
            }
        });
        
        pageTitle.addEventListener('click', () => {
            currentData = null;
            selectedBlock = null;
            uploadSection.style.display = 'block';
            controlsSection.style.display = 'none';
            vizSection.style.display = 'none';
            fileInput.value = '';
            urlInput.value = '';
            // Clear URL parameter when returning to upload screen
            window.history.replaceState({}, document.title, window.location.pathname);
        });

        // Check for URL parameter on page load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const dataUrl = urlParams.get('url') || urlParams.get('data');
            
            if (dataUrl) {
                urlInput.value = dataUrl;
                loadFromUrl();
            }
        });

        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('Please upload a JSON file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    currentData = JSON.parse(e.target.result);
                    uploadSection.style.display = 'none';
                    controlsSection.style.display = 'block';
                    vizSection.style.display = 'block';
                    updateVisualization();
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function calculateEffectiveness(item, effType) {
            switch (effType) {
                case 'cost':
                    return item.cost_before / item.cost_after;
                case 'main_columns':
                    return item.stats.before.main_columns / item.stats.after.main_columns;
                case 'constraints':
                    return item.stats.before.constraints / item.stats.after.constraints;
                case 'bus_interactions':
                    return item.stats.before.bus_interactions / item.stats.after.bus_interactions;
                default:
                    throw new Error(`Unknown effectiveness type: ${effType}`);
            }
        }

        function formatCellCount(count) {
            if (count >= 1e9) {
                return (count / 1e9).toFixed(1) + 'B';
            } else if (count >= 1e6) {
                return (count / 1e6).toFixed(1) + 'M';
            } else if (count >= 1e3) {
                return (count / 1e3).toFixed(1) + 'K';
            } else {
                return count.toFixed(0);
            }
        }

        function processData() {
            const effType = effectivenessType.value;
            const processed = currentData.map(item => ({
                start_pc: item.original_block.start_pc,
                effectiveness: calculateEffectiveness(item, effType),
                instructions: item.original_block.statements.length,
                software_version_cells: item.width_before * item.execution_frequency,
                width_before: item.width_before,
                execution_frequency: item.execution_frequency,
                statements: item.original_block.statements  // Keep the code statements
            }));

            // Sort by software_version_cells descending
            processed.sort((a, b) => b.software_version_cells - a.software_version_cells);

            return processed;
        }

        function updateVisualization() {
            const data = processData();
            const totalCells = data.reduce((sum, d) => sum + d.software_version_cells, 0);

            // Calculate weighted mean
            const meanEffectiveness = data.reduce((sum, d) => sum + d.effectiveness * d.software_version_cells, 0) / totalCells;

            // Update statistics table
            updateStatsTable(data);

            // Create visualization
            createChart(data, totalCells, meanEffectiveness);
        }

        function updateStatsTable(data) {
            const top10 = data.slice(0, 10);
            const tbody = document.getElementById('statsBody');
            tbody.innerHTML = '';

            top10.forEach((d, index) => {
                const row = tbody.insertRow();
                row.setAttribute('data-start-pc', d.start_pc);
                row.setAttribute('data-index', index);
                row.style.cursor = 'pointer';
                row.insertCell(0).textContent = '0x' + d.start_pc.toString(16);
                row.insertCell(1).textContent = formatCellCount(d.software_version_cells);
                row.insertCell(2).textContent = d.effectiveness.toFixed(2);
                row.insertCell(3).textContent = d.instructions;

                // Add hover events for table rows
                row.addEventListener('mouseenter', () => {
                    highlightElements(d.start_pc, false);
                });

                row.addEventListener('mouseleave', () => {
                    clearHighlights();
                });
                
                // Add click event for selection
                row.addEventListener('click', () => {
                    selectBlock(d);
                });
            });
        }

        function highlightElements(startPc, isHover = true) {
            // Highlight corresponding bar
            d3.selectAll('.bar')
                .classed('bar-highlight', d => d.start_pc === startPc);

            // Highlight corresponding table row
            const rows = document.querySelectorAll('#statsBody tr');
            rows.forEach(row => {
                if (parseInt(row.getAttribute('data-start-pc')) === startPc) {
                    row.classList.add('table-row-highlight');
                }
            });
        }

        function clearHighlights() {
            d3.selectAll('.bar').classed('bar-highlight', false);
            document.querySelectorAll('#statsBody tr').forEach(row => {
                row.classList.remove('table-row-highlight');
            });
        }
        
        function selectBlock(blockData) {
            // Clear previous selection
            d3.selectAll('.bar').classed('bar-selected', false);
            document.querySelectorAll('#statsBody tr').forEach(row => {
                row.classList.remove('table-row-selected');
            });
            
            // Set new selection
            selectedBlock = blockData;
            
            if (blockData && !blockData.is_other) {
                // Highlight selected bar
                d3.selectAll('.bar')
                    .classed('bar-selected', d => d.start_pc === blockData.start_pc);
                
                // Highlight selected table row
                const rows = document.querySelectorAll('#statsBody tr');
                rows.forEach(row => {
                    if (parseInt(row.getAttribute('data-start-pc')) === blockData.start_pc) {
                        row.classList.add('table-row-selected');
                    }
                });
            }
            
            // Show code for selected block
            showCode(blockData);
        }

        function showCode(blockData) {
            if (!blockData) return;
            
            const codePanel = document.getElementById('codePanel');
            const codeInfo = document.getElementById('codeBlockInfo');

            if (blockData.is_other) {
                codeInfo.innerHTML = `<strong>Other blocks (${blockData.count} APCs grouped)</strong>`;
                codePanel.innerHTML = '<span class="text-muted">Multiple blocks grouped together</span>';
                return;
            }

            codeInfo.innerHTML = `<strong>Block at PC: 0x${blockData.start_pc.toString(16)}</strong> - ${blockData.instructions} instructions`;

            if (blockData.statements && blockData.statements.length > 0) {
                const codeHtml = blockData.statements.map((stmt, idx) =>
                    `<div class="code-line">${(idx + 1).toString().padStart(3, ' ')}: ${escapeHtml(stmt)}</div>`
                ).join('');
                codePanel.innerHTML = codeHtml;
            } else {
                codePanel.innerHTML = '<span class="text-muted">No code available</span>';
            }
        }

        function clearCode() {
            // Only clear if there's no selected block
            if (!selectedBlock) {
                document.getElementById('codeBlockInfo').innerHTML = '<span class="text-muted">Click on a bar or table row to see the code</span>';
                document.getElementById('codePanel').innerHTML = '<span class="text-muted">No block selected</span>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function createChart(data, totalCells, meanEffectiveness) {
            // Clear existing chart
            d3.select('#chart').selectAll('*').remove();
            
            // Reapply selection if there was one
            if (selectedBlock) {
                // Find the block in the new data
                const stillExists = data.find(d => d.start_pc === selectedBlock.start_pc);
                if (stillExists) {
                    // Update selectedBlock with new data
                    selectedBlock = stillExists;
                } else {
                    // Block no longer exists in view, clear selection
                    selectedBlock = null;
                    clearCode();
                }
            }

            // Set dimensions and margins
            const margin = { top: 40, right: 120, bottom: 60, left: 60 };
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            // Group small blocks (< 0.1% threshold)
            const threshold = totalCells * 0.001;
            const largeBlocks = data.filter(d => d.software_version_cells >= threshold);
            const smallBlocks = data.filter(d => d.software_version_cells < threshold);

            let plotData = [...largeBlocks];

            if (smallBlocks.length > 0) {
                const otherCells = smallBlocks.reduce((sum, d) => sum + d.software_version_cells, 0);
                const otherEffectiveness = smallBlocks.reduce((sum, d) => sum + d.effectiveness * d.software_version_cells, 0) / otherCells;
                plotData.push({
                    effectiveness: otherEffectiveness,
                    software_version_cells: otherCells,
                    instructions: -1,
                    is_other: true,
                    count: smallBlocks.length,
                    statements: []  // No individual statements for grouped blocks
                });
            }

            // Calculate positions
            let xPos = 0;
            plotData.forEach(d => {
                d.x = xPos;
                d.width = d.software_version_cells;
                xPos += d.width;
            });

            // Create SVG
            const svg = d3.select('#chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Create scales
            const xScale = d3.scaleLinear()
                .domain([0, totalCells])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(plotData, d => d.effectiveness) * 1.1])
                .range([height, 0]);

            // Color scale for instructions (log scale)
            const validInstructions = plotData.filter(d => !d.is_other).map(d => d.instructions);
            const colorScale = d3.scaleSequentialLog()
                .domain([d3.min(validInstructions), d3.max(validInstructions)])
                .interpolator(d3.interpolateRdYlGn);

            // Add grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .tickSize(-height)
                    .tickFormat(''));

            svg.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft(yScale)
                    .tickSize(-width)
                    .tickFormat(''));

            // Create tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);

            // Add bars
            svg.selectAll('.bar')
                .data(plotData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.x))
                .attr('y', d => yScale(d.effectiveness))
                .attr('width', d => xScale(d.width) - xScale(0))
                .attr('height', d => height - yScale(d.effectiveness))
                .style('fill', d => d.is_other ? 'lightgray' : colorScale(d.instructions))
                .style('cursor', 'pointer')
                .on('mouseover', function (event, d) {
                    // Show tooltip
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);

                    let content = '';
                    if (d.is_other) {
                        content = `<strong>Other (${d.count} APCs)</strong><br/>
                                  Cells: ${formatCellCount(d.software_version_cells)}<br/>
                                  Effectiveness: ${d.effectiveness.toFixed(2)}`;
                    } else {
                        content = `<strong>PC: 0x${d.start_pc.toString(16)}</strong><br/>
                                  Cells: ${formatCellCount(d.software_version_cells)}<br/>
                                  Effectiveness: ${d.effectiveness.toFixed(2)}<br/>
                                  Instructions: ${d.instructions}`;
                    }

                    tooltip.html(content)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');

                    // Highlight elements (but don't change code on hover if something is selected)
                    if (!d.is_other) {
                        highlightElements(d.start_pc, true);
                    }
                })
                .on('mouseout', function (d) {
                    // Hide tooltip
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);

                    // Clear highlights
                    clearHighlights();
                })
                .on('click', function(event, d) {
                    // Select this block on click
                    selectBlock(d);
                });
            
            // Restore selection visually if there was one
            if (selectedBlock) {
                d3.selectAll('.bar')
                    .classed('bar-selected', d => d.start_pc === selectedBlock.start_pc);
            }

            // Add "Other" label for wide enough other blocks
            plotData.filter(d => d.is_other && d.width > totalCells * 0.02).forEach(d => {
                svg.append('text')
                    .attr('x', xScale(d.x + d.width / 2))
                    .attr('y', yScale(d.effectiveness / 2))
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('font-weight', 'bold')
                    .text(`Other (${d.count} APCs)`);
            });

            // Add mean line
            svg.append('line')
                .attr('class', 'mean-line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', yScale(meanEffectiveness))
                .attr('y2', yScale(meanEffectiveness));

            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d => formatCellCount(d)));

            svg.append('g')
                .call(d3.axisLeft(yScale));

            // Add labels
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Effectiveness');

            svg.append('text')
                .attr('transform', `translate(${width / 2}, ${height + margin.bottom})`)
                .style('text-anchor', 'middle')
                .text('Cumulative instruction trace cells (software version)');

            // Add title
            const effType = effectivenessType.options[effectivenessType.selectedIndex].text;
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', 0 - margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('font-weight', 'bold')
                .text(`Effectiveness by Basic Block (reduction in ${effType})`);

            // Add mean text box
            svg.append('rect')
                .attr('x', 5)
                .attr('y', 5)
                .attr('width', 80)
                .attr('height', 25)
                .style('fill', 'wheat')
                .style('opacity', 0.8)
                .style('stroke', 'gray')
                .style('stroke-width', 1)
                .style('rx', 3);

            svg.append('text')
                .attr('x', 45)
                .attr('y', 22)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .text(`Mean: ${meanEffectiveness.toFixed(2)}`);

            // Add color legend
            if (validInstructions.length > 0) {
                const legendWidth = 20;
                const legendHeight = 200;

                const legendScale = d3.scaleLinear()
                    .domain([Math.log10(d3.min(validInstructions)), Math.log10(d3.max(validInstructions))])
                    .range([legendHeight, 0]);

                const legendAxis = d3.axisRight(legendScale)
                    .ticks(5)
                    .tickFormat(d => Math.pow(10, d).toFixed(0));

                const legend = svg.append('g')
                    .attr('transform', `translate(${width + 40}, ${height / 2 - legendHeight / 2})`);

                // Create gradient
                const gradientId = 'instruction-gradient';
                const gradient = svg.append('defs')
                    .append('linearGradient')
                    .attr('id', gradientId)
                    .attr('x1', '0%')
                    .attr('y1', '100%')
                    .attr('x2', '0%')
                    .attr('y2', '0%');

                const steps = 20;
                for (let i = 0; i <= steps; i++) {
                    const t = i / steps;
                    const value = d3.min(validInstructions) * Math.pow(d3.max(validInstructions) / d3.min(validInstructions), t);
                    gradient.append('stop')
                        .attr('offset', `${t * 100}%`)
                        .style('stop-color', colorScale(value));
                }

                legend.append('rect')
                    .attr('width', legendWidth)
                    .attr('height', legendHeight)
                    .style('fill', `url(#${gradientId})`);

                legend.append('g')
                    .attr('transform', `translate(${legendWidth}, 0)`)
                    .call(legendAxis);

                legend.append('text')
                    .attr('transform', `rotate(90)`)
                    .attr('y', -legendWidth - 30)
                    .attr('x', legendHeight / 2)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .text('Instructions (log)');
            }
        }
    </script>
</body>

</html>